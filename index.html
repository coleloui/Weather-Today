<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <title>Document</title>
</head>

<body>
    <div class="row">
        <div class="col-2"></div>
        <div class="col-8 jumbotron text-center font-weight-bold bg-info text-white" id="head">Weather Search</div>
        <div class="col-2"></div>
    </div>

    <div class="row">
        <div class="col-1"></div>
        <div class="col-3">
            <h1>Search for a City:</h1>
            <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="Seattle" id="citySearch" aria-label="city"
                    aria-describedby="search">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary city" type="button" id="search">Search</button>
                </div>
            </div>
            <button class="btn btn-outline-secondary" id="clearMe" type="button">Clear Previous Search</button>
            <div id="previousSearch"></div>
        </div>
        <div class="col-1"></div>
        <div class="col-6">
            <br>
            <div class="row border rounded border-dark bg-info text-white">
                <div id="city"></div>
            </div>
            <div class="row">
                <h2 class="font-weight-bold">5-Day Forecast:</h2>
            </div>
            <div class="container"></div>
            <div class="row" id="dayCast"></div>
        </div>
        <div class="col-1"></div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
    </script>
    <script>
        var today = moment().format("MMMM Do YYYY")

        var cities = []
        var pastCity = []

        function displayCityInfo() {
            $("#dayCast").empty();
            $("#city").empty();


            var city = $("#citySearch").val().trim();

            var queryURL = "https://api.openweathermap.org/data/2.5/weather?q=" + city +
                "&units=imperial&appid=6d04cdd4b56594f37842d3a236ca3d6f";
            var forecastURL = "https://api.openweathermap.org/data/2.5/forecast?q=" + city +
                "&units=imperial&appid=6d04cdd4b56594f37842d3a236ca3d6f";

            $.ajax({
                url: queryURL,
                method: "GET"
            }).then(function (response) {
                var newDiv = $("<div>");
                var weatherIcon = response.weather[0].icon;
                var weatherURL = "http://openweathermap.org/img/wn/" + weatherIcon + "@2x.png";
                var imgEl = $("<img>");
                imgEl.attr("src", weatherURL);
                var rCity = response.name;
                var rCityEl = $("<h3>");
                rCityEl.html(rCity + ", " + today);
                rCityEl.addClass("font-weight-bold focus");
                rCityEl.append(imgEl);
                newDiv.append(rCityEl);

                var rTemp = response.main.temp;
                var rTempEl = $("<p>");
                rTempEl.html("Temperature: " + rTemp + " F");
                newDiv.append(rTempEl);

                var rHumidity = response.main.humidity;
                var rHumidityEl = $("<p>");
                rHumidityEl.html("Humidity: " + rHumidity + "%");
                newDiv.append(rHumidityEl);

                var rWind = response.wind.speed;
                var rWindEl = $("<p>");
                rWindEl.html("Wind Speed: " + rWind + "MPH");
                newDiv.append(rWindEl);

                var lat = response.coord.lat;
                var lon = response.coord.lon;

                uvURL =
                    "http://api.openweathermap.org/data/2.5/uvi?appid=6d04cdd4b56594f37842d3a236ca3d6f&lat=" +
                    lat + "&lon=" + lon


                $.ajax({
                    url: uvURL,
                    method: "GET"
                }).then(function (response) {
                    var rUv = response.value;
                    var rUvEl = $("<p>");
                    rUvEl.html("UV Index: " + rUv);
                    newDiv.append(rUvEl);
                })

                $("#city").append(newDiv);

            })

            $.ajax({
                url: forecastURL,
                method: "GET"
            }).then(function (response) {
                for (let i = 0; i < 5; i++) {
                    var day = response.list[8 * i].dt_txt;
                    var subDay = day.substring(0, 10)
                    // console.log(day)
                    var iDiv = $("<div>");
                    var card = $("<div>");
                    var cardBody = $("<div>");
                    var theDate = $("<h3>");
                    theDate.addClass("card-title");
                    iDiv.addClass("col-sm")
                    card.addClass("card bg-info text-white");
                    cardBody.addClass("card-body");
                    card.attr("style", "width: auto");

                    theDate.append(subDay);
                    cardBody.append(theDate)


                    var weatherIcon = response.list[8 * i].weather[0].icon;
                    var weatherURL = "http://openweathermap.org/img/wn/" + weatherIcon + "@2x.png";
                    var imgEl = $("<img>");
                    imgEl.attr("src", weatherURL);
                    cardBody.append(imgEl);

                    var rTemper = response.list[8 * i].main.temp;
                    var rTemperEl = $("<p>");
                    rTemperEl.addClass("card-text")
                    rTemperEl.html("Temperature: " + rTemper + " F");
                    cardBody.append(rTemperEl);

                    var rHumid = response.list[8 * i].main.humidity;
                    var rHumidEl = $("<p>");
                    rHumidEl.addClass("card-text")
                    rHumidEl.html("Humidity: " + rHumid + "%");
                    cardBody.append(rHumidEl);

                    card.append(cardBody);
                    iDiv.append(card);
                    $("#dayCast").append(iDiv);
                }
            })

        }

        function pastcities() {
            for (let y = 0; y < localStorage.length; y++) {
                var ci = $("<button>");
                ci.addClass("pastcity rounded bg-info text-white");
                ci.attr("data-name", localStorage.getItem(localStorage.key(y)));
                ci.text(localStorage.getItem(localStorage.key(y)));

                $("#previousSearch").append(ci)

            }
        }

        function pastCitySearch() {
            $("#dayCast").empty();
            $("#city").empty();
            var newCity = $(this).attr("data-name");
            $("#citySearch").append(newCity);


            var queryURL = "https://api.openweathermap.org/data/2.5/weather?q=" + newCity +
                "&units=imperial&appid=6d04cdd4b56594f37842d3a236ca3d6f";
            var forecastURL = "https://api.openweathermap.org/data/2.5/forecast?q=" + newCity +
                "&units=imperial&appid=6d04cdd4b56594f37842d3a236ca3d6f";

            $.ajax({
                url: queryURL,
                method: "GET"
            }).then(function (response) {
                var newDiv = $("<div>");
                var weatherIcon = response.weather[0].icon;
                var weatherURL = "http://openweathermap.org/img/wn/" + weatherIcon + "@2x.png";
                var imgEl = $("<img>");
                imgEl.attr("src", weatherURL);
                var rCity = response.name;
                var rCityEl = $("<h3>");
                rCityEl.html(rCity + ", " + today);
                rCityEl.addClass("font-weight-bold focus");
                rCityEl.append(imgEl);
                newDiv.append(rCityEl);

                var rTemp = response.main.temp;
                var rTempEl = $("<p>");
                rTempEl.html("Temperature: " + rTemp + " F");
                newDiv.append(rTempEl);

                var rHumidity = response.main.humidity;
                var rHumidityEl = $("<p>");
                rHumidityEl.html("Humidity: " + rHumidity + "%");
                newDiv.append(rHumidityEl);

                var rWind = response.wind.speed;
                var rWindEl = $("<p>");
                rWindEl.html("Wind Speed: " + rWind + "MPH");
                newDiv.append(rWindEl);

                var lat = response.coord.lat;
                var lon = response.coord.lon;

                uvURL =
                    "http://api.openweathermap.org/data/2.5/uvi?appid=6d04cdd4b56594f37842d3a236ca3d6f&lat=" +
                    lat + "&lon=" + lon


                $.ajax({
                    url: uvURL,
                    method: "GET"
                }).then(function (response) {
                    var rUv = response.value;
                    var rUvEl = $("<p>");
                    rUvEl.html("UV Index: " + rUv);
                    newDiv.append(rUvEl);
                })

                $("#city").append(newDiv);

            })

            $.ajax({
                url: forecastURL,
                method: "GET"
            }).then(function (response) {
                for (let i = 0; i < 5; i++) {
                    var day = response.list[8 * i].dt_txt;
                    var subDay = day.substring(0, 10)
                    // console.log(day)
                    var iDiv = $("<div>");
                    var card = $("<div>");
                    var cardBody = $("<div>");
                    var theDate = $("<h3>");
                    theDate.addClass("card-title");
                    iDiv.addClass("col-sm")
                    card.addClass("card bg-info text-white");
                    cardBody.addClass("card-body");
                    card.attr("style", "width: auto");

                    theDate.append(subDay);
                    cardBody.append(theDate)


                    var weatherIcon = response.list[8 * i].weather[0].icon;
                    var weatherURL = "http://openweathermap.org/img/wn/" + weatherIcon + "@2x.png";
                    var imgEl = $("<img>");
                    imgEl.attr("src", weatherURL);
                    cardBody.append(imgEl);

                    var rTemper = response.list[8 * i].main.temp;
                    var rTemperEl = $("<p>");
                    rTemperEl.addClass("card-text")
                    rTemperEl.html("Temperature: " + rTemper + " F");
                    cardBody.append(rTemperEl);

                    var rHumid = response.list[8 * i].main.humidity;
                    var rHumidEl = $("<p>");
                    rHumidEl.addClass("card-text")
                    rHumidEl.html("Humidity: " + rHumid + "%");
                    cardBody.append(rHumidEl);

                    card.append(cardBody);
                    iDiv.append(card);
                    $("#dayCast").append(iDiv);
                }
            })

        }

        function renderCities() {
            $("#previousSearch").empty();

            for (var x = 0; x < cities.length; x++) {
                var c = $("<button>");
                c.addClass("city rounded bg-info text-white");
                c.attr("data-name", cities[x]);
                c.text(cities[x]);
                $("#previousSearch").append(c)
            }
        }

        function clearCitySearch() {
            $("#previousSearch").empty();
            localStorage.clear();
        }

        $("#search").on("click", function (event) {
            event.preventDefault();
            event.stopPropagation()
            var city = $("#citySearch").val().trim();
            cities.push(city);
            pastCity.push(city)
            localStorage.setItem(pastCity, city);
            renderCities();
            displayCityInfo();
        });

        $(document).on("click", ".pastcity", pastCitySearch);
        $(document).on("click", "#clearMe", clearCitySearch);

        renderCities();
        pastcities();
    </script>
</body>

</html>